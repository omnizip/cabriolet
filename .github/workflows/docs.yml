name: Documentation

on:
  push:
    branches:
      - main
      - master
    paths:
      - 'docs/**'
      - '.github/workflows/docs.yml'
  pull_request:
    paths:
      - 'docs/**'
      - '.github/workflows/docs.yml'

jobs:
  build:
    name: Build Jekyll Site
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.2'
          bundler-cache: false

      - name: Cache dependencies
        uses: actions/cache@v4
        with:
          path: docs/vendor/bundle
          key: ${{ runner.os }}-gems-${{ hashFiles('docs/Gemfile.lock') }}
          restore-keys: |
            ${{ runner.os }}-gems-

      - name: Install dependencies
        run: |
          cd docs
          bundle config path vendor/bundle
          bundle install --jobs 4 --retry 3

      - name: Build Jekyll site
        run: |
          cd docs
          bundle exec jekyll build --trace
        env:
          JEKYLL_ENV: production

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: site
          path: docs/_site
          retention-days: 7

  link-check:
    name: Check Links
    runs-on: ubuntu-latest
    needs: build

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download build artifact
        uses: actions/download-artifact@v4
        with:
          name: site
          path: docs/_site

      - name: Install lychee
        run: |
          curl -sSL https://github.com/lycheeverse/lychee/releases/download/v0.14.3/lychee-v0.14.3-x86_64-unknown-linux-gnu.tar.gz | tar -xz
          sudo mv lychee /usr/local/bin/

      - name: Run link checker
        run: |
          cd docs
          lychee --config .lychee.toml _site --format markdown --output lychee-report.md
        continue-on-error: true

      - name: Display link check summary
        if: always()
        run: |
          cd docs
          if [ -f lychee-report.md ]; then
            echo "## Link Check Results" >> $GITHUB_STEP_SUMMARY
            cat lychee-report.md >> $GITHUB_STEP_SUMMARY
          fi

      - name: Check for broken links
        run: |
          cd docs
          # Re-run lychee without continue-on-error to actually fail the job
          lychee --config .lychee.toml _site

  validate-structure:
    name: Validate Documentation Structure
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Check for required files
        run: |
          cd docs

          # Check for essential files
          required_files=(
            "index.adoc"
            "README.md"
            "CONTRIBUTING.md"
            "_config.yml"
            "Gemfile"
            ".lychee.toml"
          )

          missing_files=()
          for file in "${required_files[@]}"; do
            if [ ! -f "$file" ]; then
              missing_files+=("$file")
            fi
          done

          if [ ${#missing_files[@]} -gt 0 ]; then
            echo "âŒ Missing required files:"
            printf '%s\n' "${missing_files[@]}"
            exit 1
          else
            echo "âœ… All required files present"
          fi

      - name: Validate YAML front matter
        run: |
          cd docs

          echo "Checking YAML front matter in .adoc files..."

          invalid_files=()
          for file in $(find . -name "*.adoc" -not -path "./_site/*"); do
            if ! head -1 "$file" | grep -q "^---$"; then
              invalid_files+=("$file")
            fi
          done

          if [ ${#invalid_files[@]} -gt 0 ]; then
            echo "âŒ Files missing YAML front matter:"
            printf '%s\n' "${invalid_files[@]}"
            echo ""
            echo "All .adoc files should start with YAML front matter:"
            echo "---"
            echo "title: Page Title"
            echo "nav_order: 1"
            echo "---"
            exit 1
          else
            echo "âœ… All .adoc files have valid YAML front matter"
          fi

      - name: Check for orphaned pages
        run: |
          cd docs

          echo "Checking for pages without nav_order..."

          files_without_nav=()
          for file in $(find . -name "*.adoc" -not -path "./_site/*" -not -name "index.adoc"); do
            if ! grep -q "^nav_order:" "$file"; then
              # Check if it has nav_exclude instead
              if ! grep -q "^nav_exclude: true" "$file"; then
                files_without_nav+=("$file")
              fi
            fi
          done

          if [ ${#files_without_nav[@]} -gt 0 ]; then
            echo "âš ï¸  Files without nav_order or nav_exclude:"
            printf '%s\n' "${files_without_nav[@]}"
            echo ""
            echo "Consider adding 'nav_order' or 'nav_exclude: true' to YAML front matter"
          else
            echo "âœ… All pages have navigation configuration"
          fi

  security-check:
    name: Security Scan
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.2'

      - name: Install dependencies
        run: |
          cd docs
          bundle install --jobs 4 --retry 3

      - name: Run bundle audit
        run: |
          cd docs
          gem install bundler-audit
          bundle audit check --update
        continue-on-error: true

  spell-check:
    name: Spell Check
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install aspell
        run: |
          sudo apt-get update
          sudo apt-get install -y aspell aspell-en

      - name: Check spelling
        run: |
          cd docs

          # Create custom dictionary for technical terms
          cat > .aspell.en.pws << 'EOF'
          personal_ws-1.1 en 100
          Cabriolet
          CAB
          CHM
          SZDD
          KWAJ
          HLP
          LIT
          OAB
          MSZIP
          LZX
          LZSS
          Quantum
          Ribose
          GitHub
          AsciiDoc
          Jekyll
          lychee
          UTF
          API
          CLI
          EOF

          # Find and check .adoc and .md files
          find . -type f \( -name "*.adoc" -o -name "*.md" \) \
            -not -path "./_site/*" \
            -not -path "./vendor/*" \
            -exec aspell --lang=en --mode=markdown --personal=./.aspell.en.pws list {} \; \
            | sort -u > spelling-errors.txt

          if [ -s spelling-errors.txt ]; then
            echo "âš ï¸  Potential spelling errors found:"
            cat spelling-errors.txt
            echo ""
            echo "Review these words - they may be technical terms to add to .aspell.en.pws"
          else
            echo "âœ… No spelling errors found"
          fi
        continue-on-error: true

  accessibility-check:
    name: Accessibility Check
    runs-on: ubuntu-latest
    needs: build

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download build artifact
        uses: actions/download-artifact@v4
        with:
          name: site
          path: docs/_site

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install pa11y
        run: npm install -g pa11y-ci

      - name: Run accessibility checks
        run: |
          cd docs/_site

          # Create pa11y-ci config
          cat > .pa11yci.json << 'EOF'
          {
            "defaults": {
              "standard": "WCAG2AA",
              "runners": ["axe"],
              "ignore": [
                "color-contrast"
              ]
            },
            "urls": [
              "index.html",
              "getting-started/index.html",
              "guides/index.html",
              "reference/index.html"
            ]
          }
          EOF

          pa11y-ci --config .pa11yci.json || true
        continue-on-error: true

  summary:
    name: Build Summary
    runs-on: ubuntu-latest
    needs: [build, link-check, validate-structure]
    if: always()

    steps:
      - name: Generate summary
        run: |
          echo "## Documentation Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Jekyll build completed" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Link validation completed" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Structure validation completed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“š Documentation is ready for deployment" >> $GITHUB_STEP_SUMMARY