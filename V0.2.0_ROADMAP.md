# Cabriolet v0.2.0 Roadmap

**Target Release**: Q1 2026 (Estimated: March 2026)
**Duration**: 8-12 weeks
**Status**: Planning Phase
**Last Updated**: 2025-11-24

---

## Executive Summary

Version 0.2.0 focuses on **architectural improvements** and **critical pending spec resolution** while maintaining 100% backward compatibility. This release will address the two highest-impact pending issues (LZX multi-folder extraction and LZX compression) and refactor compressor architecture for better maintainability.

### Key Goals

1. **Fix LZX multi-folder extraction** - Affects <5% of CAB files, high user impact
2. **Implement LZX VERBATIM blocks** - Enable full CHM/OAB compression round-trips
3. **Refactor compressor architecture** - Reduce duplication, improve extensibility
4. **Zero breaking changes** - Maintain full API compatibility with v0.1.x

### Success Metrics

- âœ… **LZX multi-folder**: 5 additional tests passing (from 61 to 66 pending)
- âœ… **LZX compression**: 7 additional tests passing (from 66 to 59 pending)
- âœ… **Code reduction**: 500-1000 lines removed via refactoring
- âœ… **Test coverage**: Maintain 0 failures, 100% libmspack parity
- âœ… **Performance**: No regression (target: Â±5%)
- âœ… **API stability**: Zero breaking changes

---

## Milestone Breakdown

### Milestone 1: LZX Multi-Folder Extraction Fix
**Duration**: 2-3 weeks (20-24 hours)
**Priority**: High (affects production use)
**Complexity**: Medium

#### Problem Statement

Files at non-zero offsets in second+ LZX folders fail with "Invalid block type: 0" error. This affects <5% of CAB files but is a significant limitation for comprehensive CAB support.

#### Current Status

- âœ… Single-folder LZX: 100% working (CHM files, most CABs)
- âœ… Multi-folder MSZIP: 100% working
- âœ… First file in LZX folders: 100% working
- âŒ Subsequent files in LZX folders: Fails

#### Root Cause

When extracting a file at offset > 0 within a folder:
1. Decompressor creates new LZX instance
2. Instance reads folder data from offset 0
3. Decompresses to target offset, discards output
4. Intel E8 preprocessing header reads at wrong position
5. Block type detection fails

#### Implementation Options

**Option A: Decompressor State Reuse** (Recommended)
- Maintain single decompressor per folder
- Reuse state across multiple files
- Matches libmspack architecture
- **Pros**: Clean, efficient, proven architecture
- **Cons**: Requires state management refactoring
- **Effort**: 20-24 hours

**Option B: Bitstream Position Fix**
- Fix bitstream positioning for Intel E8 header
- Keep current per-file decompressor approach
- **Pros**: Minimal changes
- **Cons**: May have other edge cases
- **Effort**: 12-16 hours (but higher risk)

**Option C: Complete Bitstream Rewrite**
- Rewrite using libmspack's READ_BITS macro pattern
- Most thorough fix
- **Pros**: Maximum compatibility
- **Cons**: High effort, high risk
- **Effort**: 40+ hours (deferred to v0.3.0+)

#### Implementation Plan

**Adopt Option A: Decompressor State Reuse**

**Phase 1: State Management** (Week 1, 8-10 hours)
1. Modify `CAB::Extractor` to maintain decompressor instances per folder
2. Add folder-to-decompressor mapping
3. Implement state cleanup on folder completion
4. Add tests for state management

Files to modify:
- [`lib/cabriolet/cab/extractor.rb`](lib/cabriolet/cab/extractor.rb:1)
- Create: `lib/cabriolet/cab/folder_state.rb`

**Phase 2: LZX State Reuse** (Week 2, 8-10 hours)
1. Modify `Decompressors::LZX` to support incremental decompression
2. Add `reset_position()` method for offset-based extraction
3. Maintain window state across files
4. Update Intel E8 preprocessing to use correct positions

Files to modify:
- `lib/cabriolet/decompressors/lzx.rb` (currently not in file list, needs to be created from base)
- `lib/cabriolet/binary/bitstream.rb` (position management)

**Phase 3: Testing & Validation** (Week 2-3, 4-6 hours)
1. Enable 5 pending LZX multi-folder specs
2. Add edge case tests
3. Verify MD5 checksums against libmspack
4. Cross-platform validation
5. Performance regression testing

Tests to enable:
- `spec/cab/libmspack_parity_spec.rb:613` - File 2 extraction
- `spec/cab/libmspack_parity_spec.rb:618` - File 3 extraction
- `spec/cab/libmspack_parity_spec.rb:624` - All 24 permutations
- `spec/cab/libmspack_parity_spec.rb:655` - Mixed MSZIP/LZX
- `spec/cab/libmspack_parity_spec.rb:502` - Single-folder validation

#### Success Criteria

- âœ… All 5 LZX multi-folder specs passing
- âœ… 100% libmspack parity maintained (73/73)
- âœ… Zero regression in existing tests
- âœ… Performance within Â±5% of v0.1.2
- âœ… State cleanup tested (no memory leaks)

#### Risk Assessment

**Medium Risk**:
- State management complexity
- Potential for subtle bugs in position tracking
- Performance impact from state maintenance

**Mitigation**:
- Extensive testing with libmspack fixtures
- MD5 checksum validation
- Memory profiling
- Fallback: Keep Option B as backup approach

---

### Milestone 2: LZX VERBATIM Block Implementation
**Duration**: 1-2 weeks (12-16 hours)
**Priority**: Medium (enables compression features)
**Complexity**: Medium

#### Problem Statement

LZX compressor currently only implements uncompressed blocks. VERBATIM blocks are needed for actual compression and to enable CHM/OAB creation with good compression ratios.

#### Current Status

- âœ… LZX decompressor: 100% working (all block types)
- âœ… LZX compressor: Uncompressed blocks only
- âŒ VERBATIM blocks: Not implemented
- âŒ ALIGNED blocks: Not implemented (deferred to v0.3.0)

#### Implementation Plan

**Phase 1: Match Finder** (Week 1, 6-8 hours)
1. Implement hash chain for match finding
2. Sliding window management
3. Match length/distance encoding
4. Position slot calculation

Create new file:
- `lib/cabriolet/compressors/lzx_match_finder.rb`

**Phase 2: VERBATIM Block Encoding** (Week 1-2, 4-6 hours)
1. Literal/match encoding
2. Main tree construction
3. Length tree construction  
4. Distance tree construction
5. Huffman encoding

Modify:
- `lib/cabriolet/compressors/lzx.rb`

**Phase 3: Testing & Validation** (Week 2, 2-4 hours)
1. Enable 7 pending compression specs
2. Round-trip validation
3. Compression ratio verification
4. Performance benchmarking

Tests to enable:
- `spec/chm/compressor_spec.rb:214` - CHM single file
- `spec/chm/compressor_spec.rb:249` - CHM multiple files
- `spec/chm/compressor_spec.rb:303` - CHM large files
- `spec/oab/decompressor_spec.rb:94` - OAB round-trip
- `spec/oab/compressor_spec.rb:191,211,228` - OAB validation (3 specs)
- `spec/compressors/lzx_spec.rb:314` - Repetitive data

#### Success Criteria

- âœ… All 7 compression specs passing
- âœ… Round-trip: compress â†’ decompress â†’ identical data
- âœ… Compression ratio: >50% for repetitive data
- âœ… Performance: Reasonable for pure Ruby (<10x slower than native)
- âœ… No regression in decompression

#### Risk Assessment

**Low-Medium Risk**:
- Algorithm complexity
- Performance concerns
- Edge case handling

**Mitigation**:
- Reference libmspack implementation
- Incremental testing
- Performance profiling
- Document "uncompressed blocks still available as fallback"

---

### Milestone 3: BaseCompressor Refactoring
**Duration**: 4-6 weeks (32-48 hours)
**Priority**: Medium (maintainability and future extensibility)
**Complexity**: High

#### Problem Statement

Current compressor implementations have significant code duplication (~500-1000 lines). Common patterns should be extracted into reusable components following object-oriented design principles.

#### Goals

1. **Reduce code duplication** by 500-1000 lines
2. **Improve maintainability** through separation of concerns
3. **Enable easier addition** of new formats
4. **Zero breaking changes** to public API
5. **100% test coverage** maintained

#### Architecture Changes

**Current State** (v0.1.2):
```
CAB::Compressor  â”€â”
CHM::Compressor  â”€â”¤  Each implements:
SZDD::Compressor â”€â”¤   - Offset calculation
KWAJ::Compressor â”€â”¤   - Header building
HLP::Compressor  â”€â”¤   - Binary writing
LIT::Compressor  â”€â”¤   - File entry management
OAB::Compressor  â”€â”˜   - (lots of duplication)
```

**Target State** (v0.2.0):
```
                 BaseCompressor (Strategy pattern)
                       â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚             â”‚             â”‚
    OffsetCalculator HeaderBuilder FormatWriter
         â”‚             â”‚             â”‚
    Format-specific implementations
         â”‚             â”‚             â”‚
    CAB, CHM, SZDD, KWAJ, HLP, LIT, OAB
```

#### Component Extraction

**1. OffsetCalculator** (Strategy Pattern)
- **Purpose**: Calculate file entry offsets and sizes
- **Interface**: `calculate_offsets(files, options) â†’ offsets_hash`
- **Implementations**:
  - `CAB::OffsetCalculator` - Folder-based with CFDATA blocks
  - `CHM::OffsetCalculator` - Section-based with chunks
  - `SZDD::OffsetCalculator` - Single-file simple offset
  - `KWAJ::OffsetCalculator` - Header + filename + data
  - `HLP::OffsetCalculator` - QuickHelp vs WinHelp (dual)
  - `LIT::OffsetCalculator` - ITOL chunks + directory
  - `OAB::OffsetCalculator` - LZX block-based

Files to create:
- `lib/cabriolet/offset_calculator.rb` (base class)
- `lib/cabriolet/{format}/offset_calculator.rb` (7 implementations)

**2. HeaderBuilder** (Builder Pattern)
- **Purpose**: Construct format-specific headers
- **Interface**: `build_header(files, options) â†’ BinData::Record`
- **Implementations**: Format-specific header construction

Files to create:
- `lib/cabriolet/header_builder.rb` (base class)
- `lib/cabriolet/{format}/header_builder.rb` (7 implementations)

**3. FormatWriter** (Template Method Pattern)
- **Purpose**: Write binary structures to output
- **Interface**: Template method with format-specific hooks
- **Implementations**: Format-specific writing logic

Files to create:
- `lib/cabriolet/format_writer.rb` (base class)
- `lib/cabriolet/{format}/format_writer.rb` (7 implementations)

**4. FileEntryManager** (Already Exists!)
- **Current**: `lib/cabriolet/file_manager.rb`
- **Action**: Integrate with BaseCompressor pattern
- **Refactor**: Move format-specific logic to strategies

#### Implementation Plan

**Phase 1: Extract OffsetCalculator** (Weeks 1-2, 12-16 hours)

1. **Week 1: Base + CAB/CHM** (6-8 hours)
   - Create `OffsetCalculator` base class
   - Extract CAB offset logic â†’ `CAB::OffsetCalculator`
   - Extract CHM offset logic â†’ `CHM::OffsetCalculator`
   - Write comprehensive tests

2. **Week 2: Remaining Formats** (6-8 hours)
   - Extract SZDD, KWAJ, HLP, LIT, OAB offset calculators
   - Integrate with existing compressors
   - Verify no functional changes

**Phase 2: Extract HeaderBuilder** (Weeks 3-4, 12-16 hours)

1. **Week 3: Base + Core Formats** (6-8 hours)
   - Create `HeaderBuilder` base class
   - Extract CAB, CHM, SZDD header builders
   - Write tests

2. **Week 4: Complex Formats** (6-8 hours)
   - Extract KWAJ, HLP, LIT, OAB header builders
   - Handle dual-format logic (QuickHelp/WinHelp)
   - Integration testing

**Phase 3: Extract FormatWriter** (Weeks 5-6, 8-12 hours)

1. **Week 5: Template Method Implementation** (4-6 hours)
   - Create `FormatWriter` base class with template method
   - Define hooks: `write_header`, `write_data`, `write_footer`
   - Migrate CAB and CHM

2. **Week 6: Complete Migration** (4-6 hours)
   - Migrate remaining 5 formats
   - Verify binary output identical
   - Performance testing

**Phase 4: BaseCompressor Integration** (Week 6, 4-6 hours)

1. Update all 7 compressors to use BaseCompressor
2. Verify component composition
3. Ensure API compatibility
4. Document patterns

#### Testing Strategy

**For Each Component**:
1. Unit tests for base classes
2. Integration tests for each format
3. Binary output comparison (v0.1.2 vs v0.2.0)
4. Performance benchmarking
5. API compatibility verification

**Validation**:
- All 1,273 tests must pass
- No change in binary output
- Performance within Â±10%
- Code coverage maintained

#### Success Criteria

- âœ… 500-1000 lines of code removed
- âœ… All tests passing (0 failures)
- âœ… Binary output identical to v0.1.2
- âœ… API fully backward compatible
- âœ… Performance within Â±10%
- âœ… Code more maintainable
- âœ… Easier to add new formats
- âœ… Each component <200 lines

#### Risk Assessment

**Medium-High Risk**:
- Large-scale refactoring
- Potential for subtle bugs
- Risk of breaking changes
- Time estimation uncertainty

**Mitigation Strategies**:
1. **Incremental approach**: One component at a time
2. **Binary comparison**: Verify output byte-for-byte
3. **Comprehensive testing**: Test after each phase
4. **Git branches**: Easy rollback if needed
5. **Feature flags**: Option to use old vs new implementation
6. **Code review**: Multiple review passes
7. **Community testing**: Beta release before final

#### Optional: Plugin Architecture Enhancement

If time permits, enhance plugin system:
- Standard interfaces for custom compressors
- Easier algorithm registration
- Better documentation
- Example plugins

---

### Milestone 4: Documentation & Polish
**Duration**: 1 week (8-10 hours)
**Priority**: High (release requirement)
**Complexity**: Low

#### Documentation Updates

**1. README.adoc** (2 hours)
- Update version to 0.2.0
- Document LZX multi-folder fix
- Add LZX VERBATIM compression notes
- Update architecture section
- Add migration guide from v0.1.x

**2. CHANGELOG.md** (1 hour)
- Complete v0.2.0 section
- Detail all changes
- Migration notes
- Breaking changes (none expected)

**3. API Documentation** (2 hours)
- Update YARD docs
- New classes documentation
- Usage examples for new components
- Architecture diagrams

**4. Guides** (2 hours)
- Update compression guide with VERBATIM info
- Add section on extending compressors
- Migration guide for custom compression code
- Performance tuning guide

**5. KNOWN_ISSUES.md** (1 hour)
- Remove LZX multi-folder section (fixed!)
- Update LZX compression notes
- Document remaining limitations

#### Performance Benchmarking

**Benchmark Suite** (2-3 hours):
1. Extraction performance (all formats)
2. Compression performance (all formats)
3. Memory usage profiling
4. CPU profiling
5. Comparison with v0.1.2

**Document**:
- Performance characteristics
- Trade-offs
- Optimization opportunities
- Platform differences

#### Release Preparation

1. Version bump to 0.2.0
2. Update all version references
3. Generate YARD documentation
4. Review test coverage
5. Security review
6. Cross-platform testing

---

## Timeline & Schedule

### Week-by-Week Breakdown

**Weeks 1-3: Milestone 1 (LZX Multi-Folder)**
- Week 1: State management implementation
- Week 2: LZX state reuse + testing
- Week 3: Validation & cross-platform testing

**Weeks 4-5: Milestone 2 (LZX VERBATIM)**
- Week 4: Match finder + initial encoding
- Week 5: Complete implementation + testing

**Weeks 6-11: Milestone 3 (Refactoring)**
- Weeks 6-7: OffsetCalculator extraction
- Weeks 8-9: HeaderBuilder extraction
- Weeks 10-11: FormatWriter extraction + integration

**Week 12: Milestone 4 (Documentation)**
- Documentation updates
- Performance benchmarking
- Release preparation

### Critical Path

```
M1 (LZX fix) â†’ M2 (VERBATIM) â†’ M3 (Refactoring) â†’ M4 (Docs) â†’ Release
```

**Dependencies**:
- M2 can start after M1 completes (independent)
- M3 requires M1 and M2 complete (affects same code)
- M4 requires M1-M3 complete (documents all changes)

**Parallel Work Possible**:
- M1 and M2 documentation can start early
- Test writing can happen alongside implementation
- Performance baselines can be established upfront

---

## Testing Strategy

### Test Coverage Goals

**Current** (v0.1.2):
- 1,273 examples, 0 failures
- 66 pending specs (5.2%)
- 100% libmspack parity

**Target** (v0.2.0):
- ~1,330 examples (57 new tests)
- 0 failures
- 54 pending specs (4.1%) - 12 resolved
- 100% libmspack parity maintained

### New Tests Required

**LZX Multi-Folder** (10 new tests):
- State management: 3 tests
- Position tracking: 2 tests
- Edge cases: 3 tests
- Performance: 2 tests

**LZX VERBATIM** (15 new tests):
- Match finding: 5 tests
- Block encoding: 5 tests
- Round-trip: 3 tests
- Performance: 2 tests

**Refactoring** (32 new tests):
- OffsetCalculator: 14 tests (2 per format)
- HeaderBuilder: 14 tests (2 per format)
- FormatWriter: 14 tests (2 per format)

### Regression Testing

**After Each Phase**:
1. Run full test suite
2. Compare against v0.1.2 binaries
3. Performance benchmarking
4. Memory profiling
5. Cross-platform validation

**Platforms**:
- Linux (Ubuntu 22.04, 24.04)
- macOS (Intel, Apple Silicon)
- Windows (10, 11)

**Ruby Versions**:
- 2.7, 3.0, 3.1, 3.2, 3.3
- JRuby (if possible)

---

## Performance Targets

### Benchmark Baselines (v0.1.2)

**Extraction** (1MB file):
- MSZIP: ~150ms
- LZX: ~200ms
- Quantum: ~180ms

**Compression** (1MB file):
- MSZIP: ~300ms
- LZX (uncompressed): ~100ms
- LZSS: ~250ms

### Target Performance (v0.2.0)

**Extraction**: Â±5% of v0.1.2
- LZX multi-folder: May be 10-15% slower due to state management
- Other formats: No regression

**Compression**: 
- LZX VERBATIM: Target 400-600ms for 1MB (pure Ruby)
- Other formats: No regression

**Memory**:
- Current: ~50MB peak for large files
- Target: No more than +10% increase

### Optimization Opportunities

**If time permits**:
1. Huffman tree caching
2. Match finder optimization
3. Buffer pooling
4. Bitstream operation batching

---

## Risk Management

### High Risks

**1. LZX State Management Complexity**
- **Impact**: High (could delay M1)
- **Probability**: Medium
- **Mitigation**: Option B as fallback, phased implementation
- **Contingency**: Ship v0.2.0 without LZX fix if blocked

**2. Refactoring Introduces Bugs**
- **Impact**: High (could break API)
- **Probability**: Medium
- **Mitigation**: Extensive testing, binary comparison, feature flags
- **Contingency**: Rollback refactoring if critical bugs found

**3. Performance Regression**
- **Impact**: Medium (user complaints)
- **Probability**: Low-Medium
- **Mitigation**: Continuous benchmarking, profiling, optimization
- **Contingency**: Accept small regression if benefits outweigh

### Medium Risks

**4. Timeline Overrun**
- **Impact**: Medium (delayed release)
- **Probability**: Medium
- **Mitigation**: Flexible milestone priorities, scope adjustment
- **Contingency**: Release with fewer features if needed

**5. Test Coverage Gaps**
- **Impact**: Medium (potential bugs in production)
- **Probability**: Low
- **Mitigation**: Comprehensive test plan, code review
- **Contingency**: Additional testing phase before release

### Low Risks

**6. Backward Compatibility Issues**
- **Impact**: High (if occurs)
- **Probability**: Very Low (explicit goal)
- **Mitigation**: API compatibility tests, deprecation warnings
- **Contingency**: Patch release to fix

**7. Documentation Incomplete**
- **Impact**: Low (can update post-release)
- **Probability**: Low
- **Mitigation**: Documentation milestone, review process
- **Contingency**: Documentation updates in v0.2.1

---

## Dependencies & Prerequisites

### Technical Dependencies

**No new runtime dependencies** (maintaining pure Ruby):
- bindata (~> 2.5) - Continue using
- thor (~> 1.3) - Continue using

**Development dependencies** (may update):
- rspec (~> 3.13) - May update to 3.14+
- rubocop (~> 1.69) - May update to latest
- benchmark-ips (new, optional) - For performance testing

### Team Dependencies

**Estimated effort**: 72-90 hours total over 12 weeks
- Average: 6-8 hours/week
- Can be done by 1 person part-time or 2 people very part-time

**Skills needed**:
- Ruby expertise (intermediate to advanced)
- Algorithm understanding (compression/decompression)
- Binary format knowledge
- Testing best practices
- Documentation writing

### External Dependencies

**None** - This is a self-contained project:
- No external APIs
- No external services
- No coordination with other projects
- Community contributions welcome but not required

---

## Success Criteria Summary

### Must Have (Required for Release)

1. âœ… **LZX multi-folder extraction working** (M1)
   - All 5 pending specs passing
   - MD5 checksums match libmspack
   - No performance regression >10%

2. âœ… **LZX VERBATIM blocks implemented** (M2)
   - All 7 compression specs passing
   - Round-trip working
   - Compression ratio >50% for repetitive data

3. âœ… **Zero breaking changes**
   - All existing code continues to work
   - API fully backward compatible
   - Binary output identical (or documented differences)

4. âœ… **Test suite passing**
   - 0 failures
   - 100% libmspack parity maintained
   - New tests for new features

5. âœ… **Documentation complete**
   - CHANGELOG updated
   - README updated
   - Migration guide written
   - API docs updated

### Should Have (Desired for Release)

6. âœ… **BaseCompressor refactoring complete** (M3)
   - All 7 formats using new architecture
   - 500+ lines of code removed
   - Each component <200 lines
   - Tests passing

7. âœ… **Performance within targets**
   - Extraction: Â±5%
   - Compression: Â±10%
   - Memory: +10% max

### Could Have (Optional for Release)

8. ðŸ”¸ **Additional test fixtures**
   - Real-world file collection
   - Edge case coverage
   - (Can be v0.2.1+)

9. ðŸ”¸ **Plugin architecture enhancement**
   - Better documentation
   - Example plugins
   - (Can be v0.2.1+)

10. ðŸ”¸ **Performance optimizations**
    - Beyond baseline targets
    - (Can be v0.2.1+)

---

## Post-Release Plan (v0.2.1+)

### Immediate Follow-up

**v0.2.1** (Bug Fixes):
- Fix any critical bugs found in v0.2.0
- Performance tuning based on user feedback
- Documentation clarifications
- Release within 2-4 weeks if needed

### Future Enhancements

**v0.3.0** (Extended Formats):
- LZX ALIGNED blocks (complete LZX implementation)
- Quantum compression refinements (if demanded)
- MSI format support (stretch goal)
- Additional test fixtures

**v0.4.0** (Advanced Features):
- Streaming API enhancements
- Parallel processing improvements
- Archive modification features
- Format conversion utilities

---

## Communication Plan

### Release Announcement

**Channels**:
- GitHub Release notes
- RubyGems announcement
- Ruby community forums
- Twitter/social media
- Project blog (if exists)

**Messaging**:
- "v0.2.0: LZX Multi-Folder Fix + Architectural Improvements"
- Highlight: 12 fewer pending specs
- Emphasize: Zero breaking changes
- Call out: LZX compression now production-ready

### User Migration

**Migration Guide Topics**:
1. What's new in v0.2.0
2. LZX multi-folder extraction now works
3. LZX compression available (VERBATIM blocks)
4. API changes (none - but document new features)
5. Performance characteristics
6. Known limitations remaining
7. How to report issues

### Community Engagement

**Feedback Collection**:
- GitHub Issues for bug reports
- Discussions for feature requests
- Survey for user priorities
- Office hours (optional)

**Contribution Opportunities**:
- Test fixture contributions
- Performance optimization
- Documentation improvements
- Plugin development

---

## Appendix A: File Changes Inventory

### Files to Create (New)

**Offset Calculators** (8 files):
```
lib/cabriolet/offset_calculator.rb
lib/cabriolet/cab/offset_calculator.rb
lib/cabriolet/chm/offset_calculator.rb
lib/cabriolet/szdd/offset_calculator.rb
lib/cabriolet/kwaj/offset_calculator.rb
lib/cabriolet/hlp/offset_calculator.rb
lib/cabriolet/lit/offset_calculator.rb
lib/cabriolet/oab/offset_calculator.rb
```

**Header Builders** (8 files):
```
lib/cabriolet/header_builder.rb
lib/cabriolet/cab/header_builder.rb
lib/cabriolet/chm/header_builder.rb
lib/cabriolet/szdd/header_builder.rb
lib/cabriolet/kwaj/header_builder.rb
lib/cabriolet/hlp/header_builder.rb
lib/cabriolet/lit/header_builder.rb
lib/cabriolet/oab/header_builder.rb
```

**Format Writers** (8 files):
```
lib/cabriolet/format_writer.rb
lib/cabriolet/cab/format_writer.rb
lib/cabriolet/chm/format_writer.rb
lib/cabriolet/szdd/format_writer.rb
lib/cabriolet/kwaj/format_writer.rb
lib/cabriolet/hlp/format_writer.rb
lib/cabriolet/lit/format_writer.rb
lib/cabriolet/oab/format_writer.rb
```

**Other New Files** (2 files):
```
lib/cabriolet/cab/folder_state.rb
lib/cabriolet/compressors/lzx_match_finder.rb
```

**Total New Files**: 26

### Files to Modify (Significant)

**Milestone 1** (LZX Multi-Folder):
```
lib/cabriolet/cab/extractor.rb - State management
lib/cabriolet/decompressors/lzx.rb - State reuse (if exists)
lib/cabriolet/binary/bitstream.rb - Position tracking
```

**Milestone 2** (LZX VERBATIM):
```
lib/cabriolet/compressors/lzx.rb - VERBATIM blocks
```

**Milestone 3** (Refactoring) - All compressors:
```
lib/cabriolet/cab/compressor.rb
lib/cabriolet/chm/compressor.rb
lib/cabriolet/szdd/compressor.rb
lib/cabriolet/kwaj/compressor.rb
lib/cabriolet/hlp/compressor.rb
lib/cabriolet/lit/compressor.rb
lib/cabriolet/oab/compressor.rb
lib/cabriolet/base_compressor.rb - Enhanced
lib/cabriolet/file_manager.rb - Integration
```

**Documentation**:
```
README.adoc
CHANGELOG.md
KNOWN_ISSUES.md
ROADMAP.md
docs/ (multiple files)
```

---

## Appendix B: Code Size Estimates

### Lines of Code (Current v0.1.2)

**Compressors** (~3,500 lines):
- CAB: ~600 lines
- CHM: ~500 lines
- SZDD: ~200 lines
- KWAJ: ~400 lines
- HLP: ~800 lines (QuickHelp + WinHelp)
- LIT: ~500 lines
- OAB: ~500 lines

**Decompressors** (~2,800 lines):
- Maintained (no changes in M3)

**Total Project**: ~17,000 lines

### Expected Changes (v0.2.0)

**New Code**:
- Offset Calculators: +1,400 lines (8 files Ã— ~175 lines)
- Header Builders: +1,400 lines (8 files Ã— ~175 lines)
- Format Writers: +1,400 lines (8 files Ã— ~175 lines)
- LZX Match Finder: +300 lines
- Folder State: +100 lines
- Tests: +800 lines (57 new tests Ã— ~14 lines avg)
- **Total New**: +5,400 lines

**Removed Code** (via refactoring):
- Compressor duplication: -800 to -1,200 lines
- **Net Removal**: -800 to -1,200 lines

**Net Change**: +4,200 to +4,600 lines
**Final Size**: ~21,200 to ~21,600 lines (24% increase)

**Code Distribution**:
- Compressors: ~3,000 lines (14%) - reduced!
- Infrastructure: +4,200 lines (20%) - new!
- Decompressors: ~2,800 lines (13%) - same
- Other: ~11,400 lines (53%) - same

---

## Appendix C: Alternatives Considered

### Alternative 1: Skip Refactoring, Focus on Fixes

**Pros**:
- Faster to release
- Lower risk
- Smaller scope

**Cons**:
- Misses opportunity for maintainability
- Technical debt accumulates
- Harder to add formats in future

**Decision**: Rejected - Refactoring is worth the investment

### Alternative 2: Complete Bitstream Rewrite (Option C)

**Pros**:
- Most thorough fix
- Maximum libmspack compatibility
- Future-proof

**Cons**:
- Very high effort (40+ hours)
- High risk of introducing bugs
- Delays release significantly

**Decision**: Deferred to v0.3.0+ if needed

### Alternative 3: Release v0.2.0 in Phases

**Approach**:
- v0.2.0-alpha: M1 only (LZX fix)
- v0.2.0-beta: M1 + M2 (VERBATIM)
- v0.2.0: M1 + M2 + M3 (Refactoring)

**Pros**:
- Get fixes out faster
- Gather early feedback
- Reduce risk

**Cons**:
- More releases to manage
- Fragmented user base
- More documentation updates

**Decision**: Consider phased approach if timeline slips

---

**Last Updated**: 2025-11-24
**Next Review**: After v0.1.2 release
**Status**: Ready for implementation planning

---

**Approval Required From**: Project maintainers
**Questions/Feedback**: Open GitHub issue with tag `v0.2.0-planning`